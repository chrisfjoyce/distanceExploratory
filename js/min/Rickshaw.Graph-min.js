Rickshaw.namespace("Rickshaw.Graph"),Rickshaw.Graph=function(e){var t=this;this.initialize=function(e){if(!e.element)throw"Rickshaw.Graph needs a reference to an element";if(1!==e.element.nodeType)throw"Rickshaw.Graph element was defined but not an HTML element";this.element=e.element,this.series=e.series,this.window={},this.updateCallbacks=[],this.configureCallbacks=[],this.defaults={interpolation:"cardinal",offset:"zero",min:void 0,max:void 0,preserve:!1,xScale:void 0,yScale:void 0},this._loadRenderers(),this.configure(e),this.validateSeries(e.series),this.series.active=function(){return t.series.filter(function(e){return!e.disabled})},this.setSize({width:e.width,height:e.height}),this.element.classList.add("rickshaw_graph"),this.vis=d3.select(this.element).append("svg:svg").attr("width",this.width).attr("height",this.height),this.discoverRange()},this._loadRenderers=function(){for(var e in Rickshaw.Graph.Renderer)if(e&&Rickshaw.Graph.Renderer.hasOwnProperty(e)){var i=Rickshaw.Graph.Renderer[e];i&&i.prototype&&i.prototype.render&&t.registerRenderer(new i({graph:t}))}},this.validateSeries=function(e){if(!(Array.isArray(e)||e instanceof Rickshaw.Series)){var t=Object.prototype.toString.apply(e);throw"series is not an array: "+t}var i;e.forEach(function(e){if(!(e instanceof Object))throw"series element is not an object: "+e;if(!e.data)throw"series has no data: "+JSON.stringify(e);if(!Array.isArray(e.data))throw"series data is not an array: "+JSON.stringify(e.data);var t=e.data[0].x,i=e.data[0].y;if("number"!=typeof t||"number"!=typeof i&&null!==i)throw"x and y properties of points should be numbers instead of "+typeof t+" and "+typeof i;if(e.data.length>=3&&(e.data[2].x<e.data[1].x||e.data[1].x<e.data[0].x||e.data[e.data.length-1].x<e.data[0].x))throw"series data needs to be sorted on x values for series name: "+e.name},this)},this.dataDomain=function(){var e=this.series.map(function(e){return e.data}),t=d3.min(e.map(function(e){return e[0].x})),i=d3.max(e.map(function(e){return e[e.length-1].x}));return[t,i]},this.discoverRange=function(){var e=this.renderer.domain();this.x=(this.xScale||d3.scale.linear()).domain(e.x).range([0,this.width]),this.y=(this.yScale||d3.scale.linear()).domain(e.y).range([this.height,0]),this.y.magnitude=d3.scale.linear().domain([e.y[0]-e.y[0],e.y[1]-e.y[0]]).range([0,this.height])},this.render=function(){var e=this.stackData();this.discoverRange(),this.renderer.render(),this.updateCallbacks.forEach(function(e){e()})},this.update=this.render,this.stackData=function(){var e=this.series.active().map(function(e){return e.data}).map(function(e){return e.filter(function(e){return this._slice(e)},this)},this),i=this.preserve;i||this.series.forEach(function(e){e.scale&&(i=!0)}),e=i?Rickshaw.clone(e):e,this.series.active().forEach(function(t,i){if(t.scale){var s=e[i];s&&s.forEach(function(e){e.y=t.scale(e.y)})}}),this.stackData.hooks.data.forEach(function(i){e=i.f.apply(t,[e])});var s;if(!this.renderer.unstack){this._validateStackable();var a=d3.layout.stack();a.offset(t.offset),s=a(e)}s=s||e,this.renderer.unstack&&s.forEach(function(e){e.forEach(function(e){e.y0=void 0===e.y0?0:e.y0})}),this.stackData.hooks.after.forEach(function(i){s=i.f.apply(t,[e])});var r=0;return this.series.forEach(function(e){e.disabled||(e.stack=s[r++])}),this.stackedData=s,s},this._validateStackable=function(){var e=this.series,t;e.forEach(function(e){if(t=t||e.data.length,t&&e.data.length!=t)throw"stacked series cannot have differing numbers of points: "+t+" vs "+e.data.length+"; see Rickshaw.Series.fill()"},this)},this.stackData.hooks={data:[],after:[]},this._slice=function(e){if(this.window.xMin||this.window.xMax){var t=!0;return this.window.xMin&&e.x<this.window.xMin&&(t=!1),this.window.xMax&&e.x>this.window.xMax&&(t=!1),t}return!0},this.onUpdate=function(e){this.updateCallbacks.push(e)},this.onConfigure=function(e){this.configureCallbacks.push(e)},this.registerRenderer=function(e){this._renderers=this._renderers||{},this._renderers[e.name]=e},this.configure=function(e){this.config=this.config||{},(e.width||e.height)&&this.setSize(e),Rickshaw.keys(this.defaults).forEach(function(t){this.config[t]=t in e?e[t]:t in this?this[t]:this.defaults[t]},this),Rickshaw.keys(this.config).forEach(function(e){this[e]=this.config[e]},this);var t=e.renderer||this.renderer&&this.renderer.name||"stack";this.setRenderer(t,e),this.configureCallbacks.forEach(function(t){t(e)})},this.setRenderer=function(e,i){if("function"==typeof e)this.renderer=new e({graph:t}),this.registerRenderer(this.renderer);else{if(!this._renderers[e])throw"couldn't find renderer "+e;this.renderer=this._renderers[e]}"object"==typeof i&&this.renderer.configure(i)},this.setSize=function(e){if(e=e||{},void 0!==typeof window)var t=window.getComputedStyle(this.element,null),i=parseInt(t.getPropertyValue("width"),10),s=parseInt(t.getPropertyValue("height"),10);this.width=e.width||i||400,this.height=e.height||s||250,this.vis&&this.vis.attr("width",this.width).attr("height",this.height)},this.initialize(e)};