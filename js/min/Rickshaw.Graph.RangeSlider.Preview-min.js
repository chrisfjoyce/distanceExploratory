Rickshaw.namespace("Rickshaw.Graph.RangeSlider.Preview"),Rickshaw.Graph.RangeSlider.Preview=Rickshaw.Class.create({initialize:function(e){if(!e.element)throw"Rickshaw.Graph.RangeSlider.Preview needs a reference to an element";if(!e.graph&&!e.graphs)throw"Rickshaw.Graph.RangeSlider.Preview needs a reference to an graph or an array of graphs";this.element=e.element,this.graphs=e.graph?[e.graph]:e.graphs,this.defaults={height:75,width:400,gripperColor:void 0,frameTopThickness:3,frameHandleThickness:10,frameColor:"#d4d4d4",frameOpacity:1,minimumFrameWidth:0},this.defaults.gripperColor=d3.rgb(this.defaults.frameColor).darker().toString(),this.configureCallbacks=[],this.slideCallbacks=[],this.previews=[],e.width=e.width||this.graphs[0].width||this.defaults.width,e.height=e.height||this.graphs[0].height/5||this.defaults.height,this.configure(e),this.render()},onSlide:function(e){this.slideCallbacks.push(e)},onConfigure:function(e){this.configureCallbacks.push(e)},configure:function(e){this.config={},this.configureCallbacks.forEach(function(t){t(e)}),Rickshaw.keys(this.defaults).forEach(function(t){this.config[t]=t in e?e[t]:t in this.config?this.config[t]:this.defaults[t]},this),e.width&&this.previews.forEach(function(t){var i=e.width-2*this.config.frameHandleThickness;t.setSize({width:i})},this),e.height&&this.previews.forEach(function(e){var t=this.previewHeight/this.graphs.length;e.setSize({height:t})},this)},render:function(){var e=this;this.svg=d3.select(this.element).selectAll("svg.rickshaw_range_slider_preview").data([null]),this.previewHeight=this.config.height-2*this.config.frameTopThickness,this.previewWidth=this.config.width-2*this.config.frameHandleThickness,this.currentFrame=[0,this.previewWidth];var t=function(t,i){var r=Rickshaw.extend({},t.config),n=e.previewHeight/e.graphs.length,s=t.renderer.name;Rickshaw.extend(r,{element:this.appendChild(document.createElement("div")),height:n,width:e.previewWidth,series:t.series,renderer:s});var a=new Rickshaw.Graph(r);e.previews.push(a),t.onUpdate(function(){a.render(),e.render()}),t.onConfigure(function(e){delete e.height,a.configure(e),a.render()}),a.render()},i=d3.select(this.element).selectAll("div.rickshaw_range_slider_preview_container").data(this.graphs),r="translate("+this.config.frameHandleThickness+"px, "+this.config.frameTopThickness+"px)";i.enter().append("div").classed("rickshaw_range_slider_preview_container",!0).style("-webkit-transform",r).style("-moz-transform",r).style("-ms-transform",r).style("transform",r).each(t),i.exit().remove();var n=this.graphs[0],s=d3.scale.linear().domain([0,this.previewWidth]).range(n.dataDomain()),a=[n.window.xMin,n.window.xMax];this.currentFrame[0]=void 0===a[0]?0:Math.round(s.invert(a[0])),this.currentFrame[0]<0&&(this.currentFrame[0]=0),this.currentFrame[1]=void 0===a[1]?this.previewWidth:s.invert(a[1]),this.currentFrame[1]-this.currentFrame[0]<e.config.minimumFrameWidth&&(this.currentFrame[1]=(this.currentFrame[0]||0)+e.config.minimumFrameWidth),this.svg.enter().append("svg").classed("rickshaw_range_slider_preview",!0).style("height",this.config.height+"px").style("width",this.config.width+"px").style("position","relative").style("top",-this.previewHeight+"px"),this._renderDimming(),this._renderFrame(),this._renderGrippers(),this._renderHandles(),this._renderMiddle(),this._registerMouseEvents()},_renderDimming:function(){var e=this.svg.selectAll("path.dimming").data([null]);e.enter().append("path").attr("fill","white").attr("fill-opacity","0.7").attr("fill-rule","evenodd").classed("dimming",!0);var t="";t+=" M "+this.config.frameHandleThickness+" "+this.config.frameTopThickness,t+=" h "+this.previewWidth,t+=" v "+this.previewHeight,t+=" h "+-this.previewWidth,t+=" z ",t+=" M "+Math.max(this.currentFrame[0],this.config.frameHandleThickness)+" "+this.config.frameTopThickness,t+=" H "+Math.min(this.currentFrame[1]+2*this.config.frameHandleThickness,this.previewWidth+this.config.frameHandleThickness),t+=" v "+this.previewHeight,t+=" H "+Math.max(this.currentFrame[0],this.config.frameHandleThickness),t+=" z",e.attr("d",t)},_renderFrame:function(){var e=this.svg.selectAll("path.frame").data([null]);e.enter().append("path").attr("stroke","white").attr("stroke-width","1px").attr("stroke-linejoin","round").attr("fill",this.config.frameColor).attr("fill-opacity",this.config.frameOpacity).attr("fill-rule","evenodd").classed("frame",!0);var t="";t+=" M "+this.currentFrame[0]+" 0",t+=" H "+(this.currentFrame[1]+2*this.config.frameHandleThickness),t+=" V "+this.config.height,t+=" H "+this.currentFrame[0],t+=" z",t+=" M "+(this.currentFrame[0]+this.config.frameHandleThickness)+" "+this.config.frameTopThickness,t+=" H "+(this.currentFrame[1]+this.config.frameHandleThickness),t+=" v "+this.previewHeight,t+=" H "+(this.currentFrame[0]+this.config.frameHandleThickness),t+=" z",e.attr("d",t)},_renderGrippers:function(){var e=this.svg.selectAll("path.gripper").data([null]);e.enter().append("path").attr("stroke",this.config.gripperColor).classed("gripper",!0);var t="";[.4,.6].forEach(function(e){t+=" M "+Math.round(this.currentFrame[0]+this.config.frameHandleThickness*e)+" "+Math.round(.3*this.config.height),t+=" V "+Math.round(.7*this.config.height),t+=" M "+Math.round(this.currentFrame[1]+this.config.frameHandleThickness*(1+e))+" "+Math.round(.3*this.config.height),t+=" V "+Math.round(.7*this.config.height)}.bind(this)),e.attr("d",t)},_renderHandles:function(){var e=this.svg.selectAll("rect.left_handle").data([null]);e.enter().append("rect").attr("width",this.config.frameHandleThickness).attr("height",this.config.height).style("cursor","ew-resize").style("fill-opacity","0").classed("left_handle",!0),e.attr("x",this.currentFrame[0]);var t=this.svg.selectAll("rect.right_handle").data([null]);t.enter().append("rect").attr("width",this.config.frameHandleThickness).attr("height",this.config.height).style("cursor","ew-resize").style("fill-opacity","0").classed("right_handle",!0),t.attr("x",this.currentFrame[1]+this.config.frameHandleThickness)},_renderMiddle:function(){var e=this.svg.selectAll("rect.middle_handle").data([null]);e.enter().append("rect").attr("height",this.config.height).style("cursor","move").style("fill-opacity","0").classed("middle_handle",!0),e.attr("width",Math.max(0,this.currentFrame[1]-this.currentFrame[0])).attr("x",this.currentFrame[0]+this.config.frameHandleThickness)},_registerMouseEvents:function(){function e(e,t){h.stop=c._getClientXFromEvent(d3.event,h);var i=h.stop-h.start,r=c.frameBeforeDrag.slice(0),n=c.config.minimumFrameWidth;h.rigid&&(n=c.frameBeforeDrag[1]-c.frameBeforeDrag[0]),h.left&&(r[0]=Math.max(r[0]+i,0)),h.right&&(r[1]=Math.min(r[1]+i,c.previewWidth));var s=r[1]-r[0];n>=s&&(h.left&&(r[0]=r[1]-n),h.right&&(r[1]=r[0]+n),r[0]<=0&&(r[1]-=r[0],r[0]=0),r[1]>=c.previewWidth&&(r[0]-=r[1]-c.previewWidth,r[1]=c.previewWidth)),c.graphs.forEach(function(e){var t=d3.scale.linear().interpolate(d3.interpolateRound).domain([0,c.previewWidth]).range(e.dataDomain()),i=[t(r[0]),t(r[1])];c.slideCallbacks.forEach(function(t){t(e,i[0],i[1])}),0===r[0]&&(i[0]=void 0),r[1]===c.previewWidth&&(i[1]=void 0),e.window.xMin=i[0],e.window.xMax=i[1],e.update()})}function t(){h.target=d3.event.target,h.start=c._getClientXFromEvent(d3.event,h),c.frameBeforeDrag=c.currentFrame.slice(),d3.event.preventDefault?d3.event.preventDefault():d3.event.returnValue=!1,d3.select(document).on("mousemove.rickshaw_range_slider_preview",e),d3.select(document).on("mouseup.rickshaw_range_slider_preview",s),d3.select(document).on("touchmove.rickshaw_range_slider_preview",e),d3.select(document).on("touchend.rickshaw_range_slider_preview",s),d3.select(document).on("touchcancel.rickshaw_range_slider_preview",s)}function i(e,i){h.left=!0,t()}function r(e,i){h.right=!0,t()}function n(e,i){h.left=!0,h.right=!0,h.rigid=!0,t()}function s(e,t){d3.select(document).on("mousemove.rickshaw_range_slider_preview",null),d3.select(document).on("mouseup.rickshaw_range_slider_preview",null),d3.select(document).on("touchmove.rickshaw_range_slider_preview",null),d3.select(document).on("touchend.rickshaw_range_slider_preview",null),d3.select(document).on("touchcancel.rickshaw_range_slider_preview",null),delete c.frameBeforeDrag,h.left=!1,h.right=!1,h.rigid=!1}var a=d3.select(this.element),h={target:null,start:null,stop:null,left:!1,right:!1,rigid:!1},c=this;a.select("rect.left_handle").on("mousedown",i),a.select("rect.right_handle").on("mousedown",r),a.select("rect.middle_handle").on("mousedown",n),a.select("rect.left_handle").on("touchstart",i),a.select("rect.right_handle").on("touchstart",r),a.select("rect.middle_handle").on("touchstart",n)},_getClientXFromEvent:function(e,t){switch(e.type){case"touchstart":case"touchmove":for(var i=e.changedTouches,r=null,n=0;n<i.length;n++)if(i[n].target===t.target){r=i[n];break}return null!==r?r.clientX:void 0;default:return e.clientX}}});