Rickshaw.namespace("Rickshaw.Graph.HoverDetail"),Rickshaw.Graph.HoverDetail=Rickshaw.Class.create({initialize:function(t){var e=this.graph=t.graph;this.xFormatter=t.xFormatter||function(t){return new Date(1e3*t).toUTCString()},this.yFormatter=t.yFormatter||function(t){return null===t?t:t.toFixed(2)};var a=this.element=document.createElement("div");a.className="detail",this.visible=!0,e.element.appendChild(a),this.lastEvent=null,this._addListeners(),this.onShow=t.onShow,this.onHide=t.onHide,this.onRender=t.onRender,this.formatter=t.formatter||this.formatter},formatter:function(t,e,a,i,n,s){return t.name+":&nbsp;"+n},update:function(t){if(t=t||this.lastEvent,t&&(this.lastEvent=t,t.target.nodeName.match(/^(path|svg|rect|circle)$/))){var e=this.graph,a=t.offsetX||t.layerX,i=t.offsetY||t.layerY,n=0,s=[],r;if(this.graph.series.active().forEach(function(t){var o=this.graph.stackedData[n++];if(o.length){var h=e.x.invert(a),l=d3.scale.linear().domain([o[0].x,o.slice(-1)[0].x]).range([0,o.length-1]),c=Math.round(l(h));c==o.length-1&&c--;for(var d=Math.min(c||0,o.length-1),m=c;m<o.length-1&&(o[m]&&o[m+1]);){if(o[m].x<=h&&o[m+1].x>h){d=Math.abs(h-o[m].x)<Math.abs(h-o[m+1].x)?m:m+1;break}o[m+1].x<=h?m++:m--}0>d&&(d=0);var u=o[d],f=Math.sqrt(Math.pow(Math.abs(e.x(u.x)-a),2)+Math.pow(Math.abs(e.y(u.y+u.y0)-i),2)),v=t.xFormatter||this.xFormatter,p=t.yFormatter||this.yFormatter,g={formattedXValue:v(u.x),formattedYValue:p(t.scale?t.scale.invert(u.y-700):u.y-700),series:t,value:u,distance:f,order:n,name:t.name};(!r||f<r.distance)&&(r=g),s.push(g)}},this),r){r.active=!0;var o=r.value.x,h=r.formattedXValue;this.element.innerHTML="",this.element.style.left=e.x(o)+"px",this.visible&&this.render({points:s,detail:s,mouseX:a,mouseY:i,formattedXValue:h,domainX:o})}}},hide:function(){this.visible=!1,this.element.classList.add("inactive"),"function"==typeof this.onHide&&this.onHide()},show:function(){this.visible=!0,this.element.classList.remove("inactive"),"function"==typeof this.onShow&&this.onShow()},render:function(t){var e=this.graph,a=t.points,i=a.filter(function(t){return t.active}).shift();if(null!==i.value.y){var n=i.formattedXValue,s=i.formattedYValue;this.element.innerHTML="",this.element.style.left=e.x(i.value.x)+"px";var r=document.createElement("div");r.className="x_label",r.innerHTML=n,this.element.appendChild(r);var o=document.createElement("div");o.className="item";var h=i.series,l=h.scale?h.scale.invert(i.value.y):i.value.y;o.innerHTML=this.formatter(h,i.value.x,l,n,s,i),o.style.top=this.graph.y(i.value.y0+i.value.y)+"px",this.element.appendChild(o);var c=document.createElement("div");c.className="dot",c.style.top=o.style.top,c.style.borderColor=h.color,this.element.appendChild(c),i.active&&(o.classList.add("active"),c.classList.add("active"));var d=[r,o];d.forEach(function(t){t.classList.add("left")}),this.show();var m=this._calcLayoutError(d);if(m>0){d.forEach(function(t){t.classList.remove("left"),t.classList.add("right")});var u=this._calcLayoutError(d);u>m&&d.forEach(function(t){t.classList.remove("right"),t.classList.add("left")})}"function"==typeof this.onRender&&this.onRender(t)}},_calcLayoutError:function(t){var e=this.element.parentNode.getBoundingClientRect(),a=0,i=t.forEach(function(t){var i=t.getBoundingClientRect();i.width&&(i.right>e.right&&(a+=i.right-e.right),i.left<e.left&&(a+=e.left-i.left))});return a},_addListeners:function(){this.graph.element.addEventListener("mousemove",function(t){this.visible=!0,this.update(t)}.bind(this),!1),this.graph.onUpdate(function(){this.update()}.bind(this)),this.graph.element.addEventListener("mouseout",function(t){!t.relatedTarget||t.relatedTarget.compareDocumentPosition(this.graph.element)&Node.DOCUMENT_POSITION_CONTAINS||this.hide()}.bind(this),!1)}});